# Perseus - pv/uv采集中心

> ## 项目目录结构说明

>> ### 分为两个模块：perseus-app、perseus-core

>>> * perseus-app对应于DDD中的防腐层、开放服务Context。主要提供RPC和RestFUL方式的服务调用，以及用于MQ消息的接收。采用SpringBoot配置和启动应用。也是数据统计微服务部署的项目。
>>> * perseus-core包含了核心公共方法。

> ## 约束与规范

>> ### Redis 失效时间统一为次日凌晨2点
>>> * redis 统计pv的key:value结构,value为String类型
```
    {PC-pv-20170929:'100'} //2017年9月29日 平台 PC端总的pv为100
    {H5-pv-20170929:'200'} //2017年9月29日 平台 H5端总的pv为200
    {APP-pv-20170929:'300'} //2017年9月29日 平台 APP端总的pv为300
```
```
    {PC-pv-20170929-sku-111:'10'} //2017年9月29日 sku编码为111 PC端的pv为10
    {PC-pv-20170929-sku-222:'9'} //2017年9月29日 sku编码为222 PC端的pv为9
    {H5-pv-20170929-sku-111:'20'} //2017年9月29日 sku编码为111 H5端的pv为20
    {H5-pv-20170929-sku-222:'19'} //2017年9月29日 sku编码为222 H5端的pv为19
    {APP-pv-20170929-sku-111:'30'} //2017年9月29日 sku编码为111 APP端的pv为30
    {APP-pv-20170929-sku-222:'29'} //2017年9月29日 sku编码为222 APP端的pv为29
```
```
    {PC-pv-20170929-platsku:'100'} //2017年9月29日 平台商品页 PC端的pv为100
    {H5-pv-20170929-platsku:'200'} //2017年9月29日 平台商品页 H5端的pv为200
    {APP-pv-20170929-platsku:'300'} //2017年9月29日 平台商品页 APP端的pv为300
```
```
    {PC-pv-20170929-shopsku-001:'70'} //2017年9月29日 001店铺商品页 PC端的pv为70
    {PC-pv-20170929-shopsku-002:'75'} //2017年9月29日 002店铺商品页 PC端的pv为75
    {H5-pv-20170929-shopsku-001:'80'} //2017年9月29日 001店铺商品页 H5端的pv为80
    {H5-pv-20170929-shopsku-002:'85'} //2017年9月29日 002店铺商品页 H5端的pv为85
    {APP-pv-20170929-shopsku-001:'90'} //2017年9月29日 001店铺商品页 APP端的pv为90
    {APP-pv-20170929-shopsku-002:'100'} //2017年9月29日 002店铺商品页 APP端的pv为100
```
```
    {PC-pv-20170929-shop-001:'75'} //2017年9月29日 001店铺总的 PC端的pv为75
    {PC-pv-20170929-shop-002:'80'} //2017年9月29日 002店铺总的 PC端的pv为80
    {H5-pv-20170929-shop-001:'85'} //2017年9月29日 001店铺总的 H5端的pv为85
    {H5-pv-20170929-shop-002:'88'} //2017年9月29日 002店铺总的 H5端的pv为89
    {APP-pv-20170929-shop-001:'99'} //2017年9月29日 001店铺总的 APP端的pv为99
    {APP-pv-20170929-shop-002:'110'} //2017年9月29日 002店铺总的 APP端的pv为110
```

>>> * redis 统计uv的key:value结构,value为Set<String>去重集合类型(size就是uv)
```
    {PC-uv-20170929:['user001','user002']} //2017年9月29日 平台 PC端的访问用户
    {H5-uv-20170929:['user001','user003']} //2017年9月29日 平台 H5端总的访问用户
    {APP-uv-20170929:['user002']} //2017年9月29日 平台 APP端总的访问用户
    {ALL-uv-20170929:['user001','user002','user003']} //2017年9月29日 平台所有端汇总的访问用户
```
```
    {PC-uv-20170929-sku-111:['user001']} //2017年9月29日 sku编码为111 PC端的访问用户
    {PC-uv-20170929-sku-222:['user001','user002']} //2017年9月29日 sku编码为222 PC端的访问用户
    {H5-uv-20170929-sku-111:['user002']} //2017年9月29日 sku编码为111 H5端的访问用户
    {H5-uv-20170929-sku-222:['user001','user003']} //2017年9月29日 sku编码为222 H5端的访问用户
    {APP-uv-20170929-sku-111:['user002']} //2017年9月29日 sku编码为111 APP端的访问用户
    {APP-uv-20170929-sku-222:['user002','user003']} //2017年9月29日 sku编码为222 APP端的访问用户
    {ALL-uv-20170929-sku-111:['user001','user002']} //2017年9月29日 sku编码为111 所有端汇总的访问用户
    {ALL-uv-20170929-sku-222:['user001','user002','user003']} //2017年9月29日 sku编码为222 所有端汇总的访问用户
```
```
    {PC-uv-20170929-platsku:['user001']} //2017年9月29日 平台商品页 PC端的访问用户
    {H5-uv-20170929-platsku:['user002']} //2017年9月29日 平台商品页 H5端的访问用户
    {APP-uv-20170929-platsku:['user003']} //2017年9月29日 平台商品页 APP端的访问用户
    {ALL-uv-20170929-platsku:['user001','user002','user003']} //2017年9月29日 平台商品页 所有端汇总的访问用户
```
```
    {PC-uv-20170929-shopsku-001:['user001']} //2017年9月29日 001店铺商品页 PC端的访问用户
    {PC-uv-20170929-shopsku-002:['user001','user003']} //2017年9月29日 002店铺商品页 PC端的访问用户
    {H5-uv-20170929-shopsku-001:['user001','user002']} //2017年9月29日 001店铺商品页 H5端的访问用户
    {H5-uv-20170929-shopsku-002:['user001','user002']} //2017年9月29日 002店铺商品页 H5端的访问用户
    {APP-uv-20170929-shopsku-001:['user002']} //2017年9月29日 001店铺商品页 APP端的访问用户
    {APP-uv-20170929-shopsku-002:['user002','user003']} //2017年9月29日 002店铺商品页 APP端的访问用户
    {ALL-uv-20170929-shopsku-001:['user002']} //2017年9月29日 001店铺商品页 所有端汇总的访问用户
    {ALL-uv-20170929-shopsku-002:['user001','user002','user003']} //2017年9月29日 002店铺商品页 所有端汇总的访问用户
```
```
    {PC-uv-20170929-shop-001:['user002','user003']} //2017年9月29日 001店铺总的 PC端的访问用户
    {PC-uv-20170929-shop-002:['user001','user003']} //2017年9月29日 002店铺总的 PC端的访问用户
    {H5-uv-20170929-shop-001:['user002']} //2017年9月29日 001店铺总的 H5端的访问用户
    {H5-uv-20170929-shop-002:['user001','user002']} //2017年9月29日 002店铺总的 H5端的访问用户
    {APP-uv-20170929-shop-001:['user003']} //2017年9月29日 001店铺总的 APP端的访问用户
    {APP-uv-20170929-shop-002:['user001','user002']} //2017年9月29日 002店铺总的 APP端的访问用户
    {ALL-uv-20170929-shopsku-001:['user002','user003']} //2017年9月29日 001店铺总的 所有端汇总的访问用户
    {ALL-uv-20170929-shopsku-002:['user001','user002','user003']} //2017年9月29日 002店铺总的 所有端汇总的访问用户
```
#### 2019-06-04 17:02:23
1、负载均衡使用nginx进行反向代理  
 ```
    upstream perseus_server{
        server localhost:8480;
        server localhost:8481;
    }
    location /perseus {
        proxy_pass http://perseus_server;
    }
    
    另外pc端的config中的PV_UV_HOST 需要设置nginx的地址
    PV_UV_HOST: 'http://nginx_server:8080/perseus',
 ```
2、定时任务修改为xxl-job分布式调度任务，需要另外部署xxl-job服务 参考http://www.xuxueli.com/xxl-job/

| IJobHandler | cron | param | desc |
| ----------- | ---- | ----- | ---- |
| PvUvJobHandler | 0 1 0 * * ? | 1 | 凌晨0点01分推送昨日汇总数据(防止定时间隔推送会遗漏24:00前的一段间隔的数据)注意: 数据在凌晨2点就会过期失效 |
| PvUvJobHandler | 0 0/5 * * * ? | !1 | 每5分钟执行一次，上一次任务执行后间隔多长时间执行下一次任务 |